// BuhBot Prisma Schema
// Database: PostgreSQL 15+ (Supabase Cloud)
// Connection: Supabase Supavisor pooler for connection pooling
// Generated from: specs/001-infrastructure-setup/data-model.md

generator client {
  provider   = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
  // Connection URLs moved to prisma.config.ts for Prisma 7
  // url and directUrl are configured there for migrations
  schemas  = ["public", "auth"]
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  admin
  manager
  observer

  @@schema("public")
}

enum ChatType {
  private
  group
  supergroup

  @@schema("public")
}

enum RequestStatus {
  pending
  in_progress
  answered
  escalated

  @@schema("public")
}

enum AlertType {
  warning
  breach

  @@schema("public")
}

enum TemplateCategory {
  greeting
  status
  document_request
  reminder
  closing

  @@schema("public")
}

// SLA Monitoring Enums (T006)
// Classification result from AI/keyword-based message analysis
enum MessageClassification {
  REQUEST // Client request requiring response (triggers SLA timer)
  SPAM // Spam/advertisement (ignored)
  GRATITUDE // Thank you messages (no response needed)
  CLARIFICATION // Follow-up to existing request

  @@schema("public")
}

// Alert delivery status for Telegram notifications
enum AlertDeliveryStatus {
  pending // Not yet sent
  sent // Sent to Telegram API
  delivered // Confirmed delivery
  failed // Failed to deliver

  @@schema("public")
}

// Resolution action that closed the alert
enum AlertAction {
  mark_resolved // Manager marked as resolved manually
  accountant_responded // Accountant replied to client
  auto_expired // Auto-closed after max escalations

  @@schema("public")
}

// Feedback Survey Enums (Module 1.2)
enum SurveyStatus {
  scheduled
  sending
  active
  closed
  expired

  @@schema("public")
}

enum DeliveryStatus {
  pending
  delivered
  reminded
  expired
  failed
  responded

  @@schema("public")
}

// ============================================================================
// MODELS
// ============================================================================

/// Admin panel users (synchronized with Supabase Auth)
/// References auth.users.id from Supabase Auth
model User {
  id               String   @id @db.Uuid
  email            String   @unique
  fullName         String   @map("full_name")
  role             String   @default("observer") // DB has text, not enum
  telegramId       BigInt?  @map("telegram_id") @db.BigInt
  telegramUsername String?  @map("telegram_username")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  isOnboardingComplete Boolean @default(false) @map("is_onboarding_complete")

  // Relations
  assignedChats      Chat[]           @relation("AssignedAccountant")
  assignedRequests   ClientRequest[]  @relation("AssignedTo")
  acknowledgedAlerts SlaAlert[]       @relation("AcknowledgedBy")
  createdTemplates   Template[]       @relation("TemplateCreator")
  createdFaqItems    FaqItem[]        @relation("FaqCreator")
  closedSurveys      FeedbackSurvey[] @relation("SurveyClosedBy")
  notifications      Notification[]
  createdInvitations ChatInvitation[] @relation("InvitationCreator")
  telegramAccount    TelegramAccount?

  @@index([email])
  @@index([role])
  @@map("users")
  @@schema("public")
}

/// In-app notifications for admin panel users
model Notification {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String
  message   String
  type      String   @default("info") // info, success, warning, error
  isRead    Boolean  @default(false) @map("is_read")
  link      String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
  @@schema("public")
}

/// Linked Telegram accounts for identity verification
model TelegramAccount {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @unique @map("user_id") @db.Uuid
  telegramId BigInt   @unique @map("telegram_id") @db.BigInt
  username   String?
  firstName  String?  @map("first_name")
  lastName   String?  @map("last_name")
  photoUrl   String?  @map("photo_url")
  authDate   BigInt   @map("auth_date") // Timestamp from Telegram auth widget
  linkedAt   DateTime @default(now()) @map("linked_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([telegramId])
  @@index([username])
  @@map("telegram_accounts")
  @@schema("public")
}

/// Telegram chat metadata for SLA tracking and accountant assignments
model Chat {
  id                   BigInt   @id @db.BigInt
  chatType             ChatType @map("chat_type")
  title                String?
  accountantUsername   String?  @map("accountant_username") // LEGACY - single accountant
  accountantUsernames  String[] @default([]) @map("accountant_usernames") // NEW - multiple accountants
  assignedAccountantId String?  @map("assigned_accountant_id") @db.Uuid
  slaEnabled           Boolean  @default(true) @map("sla_enabled")
  slaResponseMinutes   Int      @default(60) @map("sla_response_minutes")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // SLA Configuration per chat (T007)
  slaThresholdMinutes Int      @default(60) @map("sla_threshold_minutes") // SLA breach threshold
  monitoringEnabled   Boolean  @default(true) @map("monitoring_enabled") // Enable/disable monitoring
  is24x7Mode          Boolean  @default(false) @map("is_24x7_mode") // Ignore working hours
  managerTelegramIds  String[] @default([]) @map("manager_telegram_ids") // Override global managers

  // Relations
  assignedAccountant User?              @relation("AssignedAccountant", fields: [assignedAccountantId], references: [id])
  clientRequests     ClientRequest[]
  feedbackResponses  FeedbackResponse[]
  workingSchedules   WorkingSchedule[]
  holidays           ChatHoliday[]
  surveyDeliveries   SurveyDelivery[]
  messages           ChatMessage[]

  @@index([assignedAccountantId])
  @@index([slaEnabled], map: "idx_chats_sla_enabled")
  @@index([monitoringEnabled])
  @@map("chats")
  @@schema("public")
}

/// Incoming client messages for SLA monitoring and analytics
model ClientRequest {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chatId              BigInt        @map("chat_id") @db.BigInt
  messageId           BigInt        @map("message_id") @db.BigInt
  messageText         String        @map("message_text")
  clientUsername      String?       @map("client_username")
  receivedAt          DateTime      @default(now()) @map("received_at") @db.Timestamptz(6)
  assignedTo          String?       @map("assigned_to") @db.Uuid
  responseAt          DateTime?     @map("response_at") @db.Timestamptz(6)
  responseTimeMinutes Int?          @map("response_time_minutes")
  status              RequestStatus @default(pending)
  createdAt           DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // AI Classification (T008) - replaces isSpam field
  classification      MessageClassification @default(REQUEST)
  classificationScore Float?                @map("classification_score") // 0.0-1.0 confidence
  classificationModel String?               @map("classification_model") // 'openrouter', 'keyword-fallback'

  // SLA Timer details (T008)
  slaTimerStartedAt DateTime? @map("sla_timer_started_at") @db.Timestamptz(6) // When timer started
  slaTimerPausedAt  DateTime? @map("sla_timer_paused_at") @db.Timestamptz(6) // When paused (off-hours)
  slaWorkingMinutes Int?      @map("sla_working_minutes") // Calculated working minutes
  slaBreached       Boolean   @default(false) @map("sla_breached") // SLA violation flag

  // Response tracking (T008)
  respondedBy       String? @map("responded_by") @db.Uuid // Who responded
  responseMessageId BigInt? @map("response_message_id") @db.BigInt // Telegram message ID of response

  // Relations
  chat              Chat               @relation(fields: [chatId], references: [id])
  assignedUser      User?              @relation("AssignedTo", fields: [assignedTo], references: [id])
  slaAlerts         SlaAlert[]
  feedbackResponses FeedbackResponse[]
  responseMessages  ChatMessage[]      @relation("ResponseMessage")

  @@index([chatId])
  @@index([assignedTo])
  @@index([status])
  @@index([receivedAt])
  @@index([classification])
  @@index([slaBreached])
  @@index([slaTimerStartedAt])
  @@map("client_requests")
  @@schema("public")
}

/// SLA warnings and breaches for monitoring and compliance reporting
model SlaAlert {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requestId       String    @map("request_id") @db.Uuid
  alertType       AlertType @map("alert_type")
  minutesElapsed  Int       @map("minutes_elapsed")
  alertSentAt     DateTime  @default(now()) @map("alert_sent_at") @db.Timestamptz(6)
  acknowledgedAt  DateTime? @map("acknowledged_at") @db.Timestamptz(6)
  acknowledgedBy  String?   @map("acknowledged_by") @db.Uuid
  resolutionNotes String?   @map("resolution_notes")

  // Alert delivery (T009)
  telegramMessageId BigInt?             @map("telegram_message_id") @db.BigInt // Sent message ID
  deliveryStatus    AlertDeliveryStatus @default(pending) @map("delivery_status")
  deliveredAt       DateTime?           @map("delivered_at") @db.Timestamptz(6)

  // Escalation (T009)
  escalationLevel  Int       @default(1) @map("escalation_level") // 1-5 levels
  nextEscalationAt DateTime? @map("next_escalation_at") @db.Timestamptz(6) // When to escalate next

  // Resolution (T009)
  resolvedAction AlertAction? @map("resolved_action") // How alert was resolved

  // Relations
  request          ClientRequest @relation(fields: [requestId], references: [id])
  acknowledgedUser User?         @relation("AcknowledgedBy", fields: [acknowledgedBy], references: [id])

  @@index([requestId])
  @@index([alertType])
  @@index([alertSentAt])
  @@index([deliveryStatus])
  @@index([nextEscalationAt])
  @@map("sla_alerts")
  @@schema("public")
}

/// Client satisfaction ratings and feedback comments
model FeedbackResponse {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chatId         BigInt   @map("chat_id") @db.BigInt
  requestId      String?  @map("request_id") @db.Uuid
  surveyId       String?  @map("survey_id") @db.Uuid
  deliveryId     String?  @unique @map("delivery_id") @db.Uuid
  clientUsername String?  @map("client_username")
  rating         Int // 1-5 stars (validated by CHECK constraint at DB level)
  comment        String?
  submittedAt    DateTime @default(now()) @map("submitted_at") @db.Timestamptz(6)

  // Relations
  chat     Chat            @relation(fields: [chatId], references: [id])
  request  ClientRequest?  @relation(fields: [requestId], references: [id])
  survey   FeedbackSurvey? @relation(fields: [surveyId], references: [id])
  delivery SurveyDelivery? @relation(fields: [deliveryId], references: [id])

  @@index([chatId])
  @@index([rating])
  @@index([submittedAt])
  @@index([surveyId])
  @@map("feedback_responses")
  @@schema("public")
}

/// Quarterly survey campaigns for client feedback collection
model FeedbackSurvey {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quarter        String // "2025-Q1"
  scheduledAt    DateTime     @map("scheduled_at") @db.Timestamptz(6)
  sentAt         DateTime?    @map("sent_at") @db.Timestamptz(6)
  expiresAt      DateTime     @map("expires_at") @db.Timestamptz(6)
  closedAt       DateTime?    @map("closed_at") @db.Timestamptz(6)
  closedBy       String?      @map("closed_by") @db.Uuid
  status         SurveyStatus @default(scheduled)
  totalClients   Int          @default(0) @map("total_clients")
  deliveredCount Int          @default(0) @map("delivered_count")
  responseCount  Int          @default(0) @map("response_count")
  averageRating  Float?       @map("average_rating")
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  closedByUser User?              @relation("SurveyClosedBy", fields: [closedBy], references: [id])
  deliveries   SurveyDelivery[]
  responses    FeedbackResponse[]

  @@index([quarter])
  @@index([status])
  @@map("feedback_surveys")
  @@schema("public")
}

/// Individual survey delivery tracking per client chat
model SurveyDelivery {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  surveyId          String         @map("survey_id") @db.Uuid
  chatId            BigInt         @map("chat_id") @db.BigInt
  messageId         BigInt?        @map("message_id") @db.BigInt
  status            DeliveryStatus @default(pending)
  deliveredAt       DateTime?      @map("delivered_at") @db.Timestamptz(6)
  reminderSentAt    DateTime?      @map("reminder_sent_at") @db.Timestamptz(6)
  managerNotifiedAt DateTime?      @map("manager_notified_at") @db.Timestamptz(6)
  retryCount        Int            @default(0) @map("retry_count")
  errorMessage      String?        @map("error_message")
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  survey   FeedbackSurvey    @relation(fields: [surveyId], references: [id])
  chat     Chat              @relation(fields: [chatId], references: [id])
  response FeedbackResponse?

  @@unique([surveyId, chatId], name: "unique_survey_chat")
  @@index([surveyId])
  @@index([chatId])
  @@index([status])
  @@map("survey_deliveries")
  @@schema("public")
}

/// Working hours per chat for accurate SLA calculation
/// Excludes weekends and off-hours from SLA tracking
model WorkingSchedule {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chatId    BigInt   @map("chat_id") @db.BigInt
  dayOfWeek Int      @map("day_of_week") // 1=Monday, 7=Sunday (validated by CHECK constraint at DB level)
  startTime DateTime @map("start_time") @db.Time(6)
  endTime   DateTime @map("end_time") @db.Time(6)
  isActive  Boolean  @default(true) @map("is_active")
  timezone  String   @default("Europe/Moscow") // IANA timezone (T010)

  // Relations
  chat Chat @relation(fields: [chatId], references: [id])

  @@unique([chatId, dayOfWeek], name: "unique_chat_day")
  @@index([chatId])
  @@index([dayOfWeek])
  @@map("working_schedules")
  @@schema("public")
}

/// Reusable message templates for quick responses
/// Supports variable substitution with {{variable}} syntax
model Template {
  id         String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title      String
  content    String
  category   TemplateCategory
  createdBy  String           @map("created_by") @db.Uuid
  usageCount Int              @default(0) @map("usage_count")
  createdAt  DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  creator User @relation("TemplateCreator", fields: [createdBy], references: [id])

  @@index([category])
  @@index([usageCount(sort: Desc)])
  @@index([createdBy])
  @@map("templates")
  @@schema("public")
}

/// Frequently asked questions and answers for inline button quick replies
/// Keywords array enables fast full-text search
model FaqItem {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  question   String
  answer     String
  keywords   String[] @default([])
  usageCount Int      @default(0) @map("usage_count")
  createdBy  String   @map("created_by") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  creator User @relation("FaqCreator", fields: [createdBy], references: [id])

  // Note: GIN index on keywords[] is created at DB level via migration
  // Prisma doesn't support GIN index syntax in schema
  @@index([usageCount(sort: Desc)])
  @@index([createdBy])
  @@map("faq_items")
  @@schema("public")
}

// ============================================================================
// SLA MONITORING MODELS (T011-T014)
// ============================================================================

/// Global system settings singleton (T011)
/// Single row with id="default" for system-wide configuration
model GlobalSettings {
  id String @id

  // Telegram Bot
  botToken    String? @map("bot_token")
  botUsername String? @map("bot_username")
  botId       BigInt? @map("bot_id")

  // Working Hours Defaults
  defaultTimezone    String @default("Europe/Moscow") @map("default_timezone")
  defaultWorkingDays Int[]  @default([1, 2, 3, 4, 5]) @map("default_working_days") // 1=Mon..5=Fri
  defaultStartTime   String @default("09:00") @map("default_start_time") // HH:MM format
  defaultEndTime     String @default("18:00") @map("default_end_time") // HH:MM format

  // SLA Defaults
  defaultSlaThreshold   Int @default(60) @map("default_sla_threshold") // Minutes
  maxEscalations        Int @default(5) @map("max_escalations") // Max escalation levels
  escalationIntervalMin Int @default(30) @map("escalation_interval_min") // Minutes between escalations

  // Manager Alerts
  globalManagerIds String[] @default([]) @map("global_manager_ids") // Telegram IDs

  // Lead Notifications (for Landing Page)
  leadNotificationIds String[] @default([]) @map("lead_notification_ids") // Telegram IDs

  // AI Classification
  aiConfidenceThreshold Float   @default(0.7) @map("ai_confidence_threshold") // 0.0-1.0
  messagePreviewLength  Int     @default(500) @map("message_preview_length") // Chars in alert preview
  openrouterApiKey      String? @map("openrouter_api_key") // OpenRouter API key for classification
  openrouterModel       String  @default("openai/gpt-oss-120b") @map("openrouter_model") // Model name

  // Data Retention
  dataRetentionYears Int @default(3) @map("data_retention_years")

  // Survey Configuration (Module 1.2)
  surveyValidityDays Int @default(7) @map("survey_validity_days")
  surveyReminderDay  Int @default(2) @map("survey_reminder_day")
  lowRatingThreshold Int @default(3) @map("low_rating_threshold")
  surveyQuarterDay   Int @default(1) @map("survey_quarter_day")

  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("global_settings")
  @@schema("public")
}

/// Global calendar of federal holidays (T012)
/// Russian federal holidays for SLA calculation
model GlobalHoliday {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date      DateTime @unique @db.Date // Holiday date
  name      String // Holiday name (e.g., "Новый год")
  year      Int // Year for easier filtering
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([year])
  @@index([date])
  @@map("global_holidays")
  @@schema("public")
}

/// Chat-specific holidays overriding global (T013)
/// Custom non-working days per chat
model ChatHoliday {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chatId      BigInt   @map("chat_id") @db.BigInt
  date        DateTime @db.Date
  description String? // Optional description

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([chatId, date], name: "unique_chat_holiday")
  @@index([chatId])
  @@index([date])
  @@map("chat_holidays")
  @@schema("public")
}

/// AI classification result cache (T014)
/// Caches expensive AI classification calls by message hash
model ClassificationCache {
  id             String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageHash    String                @unique @map("message_hash") // SHA256 of normalized text
  classification MessageClassification
  confidence     Float // 0.0-1.0
  model          String // 'openrouter', 'keyword-fallback'
  createdAt      DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt      DateTime              @map("expires_at") @db.Timestamptz(6) // Cache TTL

  @@index([messageHash])
  @@index([expiresAt])
  @@map("classification_cache")
  @@schema("public")
}

/// Landing page contact form submissions (Lead capture)
model ContactRequest {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  email     String
  company   String?
  message   String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Status tracking
  isProcessed Boolean   @default(false) @map("is_processed")
  processedAt DateTime? @map("processed_at") @db.Timestamptz(6)
  processedBy String?   @map("processed_by") @db.Uuid // User ID if processed by admin

  @@map("contact_requests")
  @@schema("public")
}

/// Invitations for connecting new chats via Deep Linking or Command
model ChatInvitation {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token                String   @unique // The code used in /start or /connect
  initialTitle         String?  @map("initial_title") // Pre-defined title
  assignedAccountantId String?  @map("assigned_accountant_id") @db.Uuid
  createdBy            String   @map("created_by") @db.Uuid
  isUsed               Boolean  @default(false) @map("is_used")
  usedAt               DateTime? @map("used_at") @db.Timestamptz(6)
  createdChatId        BigInt?  @map("created_chat_id") @db.BigInt
  expiresAt            DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  creator User @relation("InvitationCreator", fields: [createdBy], references: [id])

  @@index([token])
  @@index([isUsed])
  @@map("chat_invitations")
  @@schema("public")
}

/// Complete message log for monitored chats
/// Stores both client and accountant messages
model ChatMessage {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chatId            BigInt   @map("chat_id") @db.BigInt
  messageId         BigInt   @map("message_id") @db.BigInt
  telegramUserId    BigInt   @map("telegram_user_id") @db.BigInt
  username          String?
  firstName         String?  @map("first_name")
  lastName          String?  @map("last_name")
  messageText       String   @map("message_text")
  isAccountant      Boolean  @default(false) @map("is_accountant")
  replyToMessageId  BigInt?  @map("reply_to_message_id") @db.BigInt
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Link to request if this message resolved it
  resolvedRequestId String?  @map("resolved_request_id") @db.Uuid

  // Relations
  chat              Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  resolvedRequest   ClientRequest? @relation("ResponseMessage", fields: [resolvedRequestId], references: [id])

  @@unique([chatId, messageId], name: "unique_chat_message")
  @@index([chatId])
  @@index([createdAt])
  @@index([isAccountant])
  @@index([chatId, createdAt(sort: Desc)], name: "idx_chat_messages_chat_created")
  @@index([chatId, isAccountant, createdAt], name: "idx_chat_messages_chat_accountant_created")
  @@map("chat_messages")
  @@schema("public")
}