# Назначение бухгалтеров в чатах

## Обзор

Функция назначения бухгалтеров позволяет системе BuhBot определять, кто из участников чата является бухгалтером. Это необходимо для:

- **Отслеживания SLA** - система измеряет время ответа бухгалтера на запросы клиентов
- **Классификации сообщений** - сообщения клиентов и бухгалтеров обрабатываются по-разному
- **Аналитики** - отчеты по времени ответа и нагрузке на бухгалтеров

## Быстрый старт

Самый простой способ добавить бухгалтера в чат:

1. Откройте страницу чата в панели управления
2. Найдите раздел **"Настройки чата"**
3. В поле **"Бухгалтеры (@username)"** введите Telegram-username бухгалтера
4. Нажмите кнопку **"+"** или Enter
5. Нажмите **"Сохранить"**

**Пример:**

```
Поле ввода: @ivan_accountant
[+] -> появится чип: @ivan_accountant
```

Можно добавить несколько бухгалтеров - просто повторите процедуру для каждого.

## Методы назначения

BuhBot поддерживает два метода идентификации бухгалтеров:

### 1. Список @username (рекомендуется)

Простой способ - указать Telegram-username бухгалтеров напрямую.

**Как использовать:**

- Введите username в поле "Бухгалтеры (@username)"
- Можно указывать с символом @ или без него
- Поддерживается несколько бухгалтеров на один чат

**Требования к username:**

- Длина: 5-32 символа
- Разрешены: латинские буквы, цифры, подчеркивание
- Не может начинаться или заканчиваться на подчеркивание

### 2. Ответственный бухгалтер (связь с пользователем)

Продвинутый способ - привязка к зарегистрированному пользователю в системе.

**Как использовать:**

- Выберите бухгалтера из выпадающего списка "Ответственный бухгалтер"
- Бухгалтер должен быть зарегистрирован в системе

**Дополнительные возможности:**

- Доступ к личному кабинету
- Персональные отчеты и статистика
- Управление несколькими чатами

## Сравнение методов

| Характеристика             | @username (рекомендуется)         | Ответственный бухгалтер       |
| -------------------------- | --------------------------------- | ----------------------------- |
| Простота настройки         | Очень простая                     | Требует регистрации           |
| Несколько бухгалтеров      | Да                                | Нет (только один)             |
| Доступ к панели управления | Нет                               | Да                            |
| Персональные отчеты        | Нет                               | Да                            |
| Подходит для               | Быстрого старта, небольших команд | Крупных компаний с аналитикой |

## Настройка через интерфейс

### Шаг 1: Откройте настройки чата

1. Перейдите в раздел **"Чаты"** в боковом меню
2. Выберите нужный чат из списка
3. На странице чата найдите карточку **"Настройки чата"**

### Шаг 2: Добавьте бухгалтеров по @username

1. Найдите поле **"Бухгалтеры (@username)"**
2. Введите username (например: `ivan_buh` или `@ivan_buh`)
3. Нажмите **"+"** или клавишу Enter
4. Username появится в виде чипа с иконкой пользователя
5. Для удаления нажмите **X** на чипе

### Шаг 3: (Опционально) Назначьте ответственного

1. Найдите поле **"Ответственный бухгалтер"**
2. Выберите пользователя из выпадающего списка
3. Если бухгалтера нет в списке - его нужно сначала зарегистрировать

### Шаг 4: Сохраните настройки

Нажмите кнопку **"Сохранить"** в нижней части формы.

## Как работает определение бухгалтера

Когда в чат приходит сообщение, система проверяет отправителя в следующем порядке:

1. **Список @username** - проверяется, есть ли username отправителя в массиве `accountantUsernames`
2. **Telegram username ответственного** - сравнивается с `telegramUsername` привязанного пользователя
3. **Telegram ID ответственного** - сравнивается с `telegramId` привязанного пользователя

Проверка останавливается на первом совпадении.

## Лучшие практики

### Когда использовать @username

- **Быстрый старт** - добавить бухгалтеров можно за минуту
- **Небольшая команда** - 1-3 бухгалтера на чат
- **Простые требования** - нужно только отслеживание SLA
- **Временные сотрудники** - легко добавить и удалить

### Когда использовать ответственного бухгалтера

- **Требуется аналитика** - персональные отчеты по бухгалтеру
- **Доступ к панели** - бухгалтер работает через веб-интерфейс
- **Централизованное управление** - один бухгалтер на несколько чатов
- **Аудит** - нужна привязка к конкретному сотруднику

### Можно использовать оба метода

Для одного чата можно настроить и @username, и ответственного бухгалтера. Система проверит оба варианта.

## Решение проблем

### Бухгалтер не распознается системой

**Возможные причины:**

1. **Неверный username**
   - Проверьте написание username в настройках чата
   - Убедитесь, что username указан без опечаток
   - Сравните с username в профиле Telegram

2. **Username изменен**
   - Если бухгалтер сменил username в Telegram, обновите его в настройках чата

3. **Username не соответствует формату**
   - Минимум 5 символов
   - Только латиница, цифры и подчеркивание

**Как проверить:**

- Откройте профиль бухгалтера в Telegram
- Скопируйте username и вставьте в настройки чата
- Сохраните и протестируйте отправкой сообщения

### Ошибка при добавлении username

| Ошибка                       | Причина                                                     | Решение                                                  |
| ---------------------------- | ----------------------------------------------------------- | -------------------------------------------------------- |
| "Неверный формат username"   | Username слишком короткий или содержит недопустимые символы | Введите корректный username (5-32 символа, a-z, 0-9, \_) |
| "Этот username уже добавлен" | Username уже есть в списке                                  | Проверьте список добавленных бухгалтеров                 |

### SLA не останавливается после ответа

1. Убедитесь, что бухгалтер добавлен в настройки чата
2. Проверьте, что SLA-мониторинг включен для чата
3. Убедитесь, что бухгалтер отвечает в том же чате, где поступил запрос

### Ответственный бухгалтер не отображается в списке

- Пользователь должен быть зарегистрирован в системе
- Проверьте, что у пользователя есть права на работу с чатами
- Обратитесь к администратору для добавления пользователя

## Примеры конфигурации

### Один бухгалтер (простой вариант)

```
Бухгалтеры (@username): @elena_buh
Ответственный бухгалтер: (не выбран)
```

### Несколько бухгалтеров

```
Бухгалтеры (@username): @elena_buh, @ivan_acc, @maria_fin
Ответственный бухгалтер: (не выбран)
```

### Комбинированный вариант

```
Бухгалтеры (@username): @junior_assistant
Ответственный бухгалтер: Елена Петрова (elena@company.ru)
```

В этом случае система распознает и помощника по username, и основного бухгалтера по привязке к пользователю.

---

**Связанные разделы:**

- [Настройка SLA-мониторинга](./sla-monitoring.md)
- [Управление пользователями](./user-management.md)
