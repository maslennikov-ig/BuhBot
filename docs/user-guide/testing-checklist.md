# Чек-лист тестирования: Назначение бухгалтеров по @username

> **Дата:** 2025-12-20
> **Версия:** После исправлений по code-review

---

## Предварительные требования

1. Запущен локальный backend (`pnpm dev` в папке backend)
2. Запущен локальный frontend (`pnpm dev` в папке frontend)
3. Есть доступ к тестовому Telegram-чату с ботом
4. Есть доступ к веб-интерфейсу BuhBot

---

## Часть 1: Проверка UI компонента

### 1.1 Открыть настройки чата

1. Зайти в веб-интерфейс: `http://localhost:3000`
2. Авторизоваться
3. Перейти в раздел **Чаты**
4. Выбрать любой чат
5. Открыть **Настройки чата** (иконка шестеренки)

**Ожидаемый результат:** Видно поле "Бухгалтеры (@username)" с возможностью ввода

---

### 1.2 Добавление валидного username

1. В поле ввода ввести: `testuser123`
2. Нажать Enter или кнопку "+"

**Ожидаемый результат:**

- [ ] Username добавлен как чип/тег
- [ ] Поле ввода очистилось
- [ ] Чип отображает `@testuser123`

---

### 1.3 Добавление username с @ префиксом

1. Ввести: `@another_user`
2. Нажать Enter

**Ожидаемый результат:**

- [ ] Username добавлен (@ удален автоматически)
- [ ] Чип отображает `@another_user`

---

### 1.4 Валидация: слишком короткий username

1. Ввести: `abc` (3 символа)
2. Нажать Enter

**Ожидаемый результат:**

- [ ] Появилось сообщение об ошибке
- [ ] Текст ошибки содержит: "5-32 символа"
- [ ] Username НЕ добавлен

---

### 1.5 Валидация: underscore в начале

1. Ввести: `_username`
2. Нажать Enter

**Ожидаемый результат:**

- [ ] Появилось сообщение об ошибке
- [ ] Текст содержит: "не начинается/заканчивается на \_"
- [ ] Username НЕ добавлен

---

### 1.6 Валидация: underscore в конце

1. Ввести: `username_`
2. Нажать Enter

**Ожидаемый результат:**

- [ ] Появилось сообщение об ошибке
- [ ] Username НЕ добавлен

---

### 1.7 Валидация: дубликат

1. Добавить username `testuser123` (если еще не добавлен)
2. Попробовать добавить `testuser123` снова

**Ожидаемый результат:**

- [ ] Появилось сообщение: "Этот username уже добавлен"
- [ ] Дубликат НЕ добавлен

---

### 1.8 Удаление username

1. Нажать на X рядом с любым добавленным username

**Ожидаемый результат:**

- [ ] Username удален из списка
- [ ] Чип исчез с анимацией

---

### 1.9 Сохранение настроек

1. Добавить несколько username: `accountant1`, `accountant2`
2. Нажать кнопку "Сохранить"

**Ожидаемый результат:**

- [ ] Появилось сообщение "Настройки успешно сохранены"
- [ ] После перезагрузки страницы username сохранены

---

## Часть 2: Проверка распознавания бухгалтера в Telegram

### 2.1 Подготовка

1. В настройках чата добавить свой Telegram @username
2. Сохранить настройки
3. Открыть Telegram-чат с ботом

---

### 2.2 Тест: сообщение от клиента

1. Отправить сообщение от имени клиента (НЕ бухгалтера): "Вопрос по налогам"
2. Подождать несколько секунд

**Ожидаемый результат:**

- [ ] Создана новая заявка (ClientRequest) со статусом `pending`
- [ ] В логах backend видно: `Client request created`

---

### 2.3 Тест: ответ бухгалтера

1. С аккаунта, чей @username добавлен в настройках чата, ответить на сообщение клиента
2. Проверить логи backend

**Ожидаемый результат:**

- [ ] В логах видно: `Accountant matched by accountantUsernames array (Check 0)`
- [ ] Заявка переведена в статус `answered`
- [ ] SLA таймер остановлен

---

### 2.4 Тест: несколько бухгалтеров

1. Добавить второй @username в настройки чата
2. Отправить новое сообщение от клиента
3. Ответить с аккаунта второго бухгалтера

**Ожидаемый результат:**

- [ ] Второй бухгалтер также распознается
- [ ] В логах: `matchedCheck: 'accountantUsernames_array'`

---

## Часть 3: Проверка API

### 3.1 Получить чат через API

```bash
curl -X POST http://localhost:4000/trpc/chats.getById \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"id": CHAT_ID}'
```

**Ожидаемый результат:**

- [ ] В ответе есть поле `accountantUsernames: ["username1", "username2"]`

---

### 3.2 Обновить чат через API

```bash
curl -X POST http://localhost:4000/trpc/chats.update \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "id": CHAT_ID,
    "accountantUsernames": ["new_accountant"]
  }'
```

**Ожидаемый результат:**

- [ ] Ответ `success: true`
- [ ] Username сохранен в базе

---

### 3.3 Проверка валидации API

```bash
curl -X POST http://localhost:4000/trpc/chats.update \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "id": CHAT_ID,
    "accountantUsernames": ["_invalid"]
  }'
```

**Ожидаемый результат:**

- [ ] Ошибка валидации
- [ ] Username начинающийся с `_` отклонен

---

## Часть 4: Запуск автотестов

### 4.1 Backend тесты

```bash
cd backend
pnpm test -- --testPathPattern="response.handler"
```

**Ожидаемый результат:**

- [ ] 34 теста пройдено
- [ ] Нет failed тестов

---

### 4.2 Frontend тесты

```bash
cd frontend
pnpm test
```

**Ожидаемый результат:**

- [ ] 28 тестов пройдено
- [ ] Нет failed тестов

---

## Часть 5: Проверка в базе данных

### 5.1 Проверить структуру таблицы

```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'chats'
  AND column_name = 'accountant_usernames';
```

**Ожидаемый результат:**

- [ ] Колонка существует
- [ ] Тип данных: `ARRAY` или `text[]`

---

### 5.2 Проверить данные

```sql
SELECT id, title, accountant_usernames
FROM chats
WHERE cardinality(accountant_usernames) > 0;
```

**Ожидаемый результат:**

- [ ] Видны чаты с заполненным массивом username

---

## Итоговый чек-лист

| #   | Проверка                           | Статус |
| --- | ---------------------------------- | ------ |
| 1   | UI: Добавление валидного username  | ☐      |
| 2   | UI: Нормализация @ префикса        | ☐      |
| 3   | UI: Валидация коротких username    | ☐      |
| 4   | UI: Валидация underscore в начале  | ☐      |
| 5   | UI: Валидация underscore в конце   | ☐      |
| 6   | UI: Валидация дубликатов           | ☐      |
| 7   | UI: Удаление username              | ☐      |
| 8   | UI: Сохранение настроек            | ☐      |
| 9   | Telegram: Распознавание бухгалтера | ☐      |
| 10  | Telegram: Несколько бухгалтеров    | ☐      |
| 11  | API: Получение accountantUsernames | ☐      |
| 12  | API: Валидация при обновлении      | ☐      |
| 13  | Tests: Backend (34 теста)          | ☐      |
| 14  | Tests: Frontend (28 тестов)        | ☐      |
| 15  | DB: Колонка существует             | ☐      |

---

## Известные ограничения

1. **Case-insensitive:** Username нормализуются к lowercase при сохранении
2. **Минимум 5 символов:** Telegram требует минимум 5 символов в username
3. **Приоритет:** `accountantUsernames` имеет высший приоритет (Check 0) над legacy полями

---

## Логи для отладки

При проблемах проверить логи backend:

```bash
# Фильтр по response-handler
grep "response-handler" logs/app.log | tail -50

# Или в реальном времени
tail -f logs/app.log | grep "response-handler"
```

Ключевые сообщения:

- `Accountant matched by accountantUsernames array (Check 0)` - успешное распознавание
- `No accountant match found` - бухгалтер не распознан
- `Chat configuration for accountant check` - конфигурация чата

---

**Автор:** Claude Code
**Создано:** 2025-12-20
