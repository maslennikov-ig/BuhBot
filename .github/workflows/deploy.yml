name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_approval:
        description: 'Skip manual approval (emergency deploy)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  VDS_DEPLOY_PATH: /home/buhbot/BuhBot

jobs:
  # ==========================================================================
  # Wait for CI - Ensure CI passes before deployment
  # ==========================================================================
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'CI Success'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success

  # ==========================================================================
  # Build Production Images
  # ==========================================================================
  build-production:
    name: Build Production Images
    runs-on: ubuntu-latest
    needs: [wait-for-ci]
    if: always() && (needs.wait-for-ci.result == 'success' || github.event_name == 'workflow_dispatch')
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}/buhbot
          tags: |
            type=sha,prefix=
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.version }}

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          load: true
          tags: buhbot-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          load: true
          tags: buhbot-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Build monitoring stack image
        uses: docker/build-push-action@v5
        with:
          context: ./infrastructure/monitoring
          file: ./infrastructure/monitoring/Dockerfile
          push: false
          load: true
          tags: buhbot-monitoring:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker images as artifacts
        run: |
          mkdir -p /tmp/docker-images
          docker save buhbot-backend:${{ github.sha }} | gzip > /tmp/docker-images/backend.tar.gz
          docker save buhbot-frontend:${{ github.sha }} | gzip > /tmp/docker-images/frontend.tar.gz
          docker save buhbot-monitoring:${{ github.sha }} | gzip > /tmp/docker-images/monitoring.tar.gz

      - name: Upload Docker images artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: /tmp/docker-images/
          retention-days: 1

  # ==========================================================================
  # Manual Approval Gate
  # ==========================================================================
  approve-deployment:
    name: Approve Deployment
    runs-on: ubuntu-latest
    needs: [build-production]
    environment: production
    if: github.event.inputs.skip_approval != 'true'

    steps:
      - name: Deployment approved
        run: |
          echo "Deployment to production has been approved"
          echo "Commit: ${{ github.sha }}"
          echo "Version: ${{ needs.build-production.outputs.version }}"
          echo "Triggered by: ${{ github.actor }}"

  # ==========================================================================
  # Deploy to VDS
  # ==========================================================================
  deploy-to-vds:
    name: Deploy to VDS
    runs-on: ubuntu-latest
    needs: [build-production, approve-deployment]
    if: always() && needs.build-production.result == 'success' && (needs.approve-deployment.result == 'success' || github.event.inputs.skip_approval == 'true')
    environment:
      name: production
      url: https://buhbot.maslennikov.space

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker images artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: /tmp/docker-images/

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VDS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VDS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} "echo 'SSH connection successful'"

      - name: Transfer Docker images to VDS
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            /tmp/docker-images/*.tar.gz \
            ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }}:/tmp/

      - name: Load Docker images on VDS
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} << 'EOF'
          set -e
          echo "Loading Docker images..."
          gunzip -c /tmp/backend.tar.gz | docker load
          gunzip -c /tmp/frontend.tar.gz | docker load
          gunzip -c /tmp/monitoring.tar.gz | docker load
          rm -f /tmp/backend.tar.gz /tmp/frontend.tar.gz /tmp/monitoring.tar.gz
          echo "Docker images loaded successfully"
          EOF

      - name: Sync repository to VDS
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'backend/node_modules' \
            --exclude 'frontend/node_modules' \
            --exclude 'frontend/.next' \
            --exclude '*.log' \
            ./ ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }}:${{ env.VDS_DEPLOY_PATH }}/

      - name: Run deployment script on VDS
        id: deploy
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} << 'EOF'
          set -e
          cd ${{ env.VDS_DEPLOY_PATH }}

          echo "==================================="
          echo "Starting BuhBot deployment..."
          echo "Commit: ${{ github.sha }}"
          echo "==================================="

          # Run the deployment script
          chmod +x infrastructure/scripts/github-deploy.sh
          infrastructure/scripts/github-deploy.sh --commit "${{ github.sha }}" --version "${{ needs.build-production.outputs.version }}"
          EOF

      - name: Health check after deployment
        id: healthcheck
        run: |
          echo "Waiting for services to stabilize..."
          sleep 30

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} << 'EOF'
          set -e

          echo "Running health checks..."

          # Check bot-backend
          for i in {1..10}; do
            if curl -f -s http://localhost:3000/health; then
              echo ""
              echo "Bot backend: OK"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "Bot backend health check failed!"
              exit 1
            fi
            echo "Waiting for bot-backend... ($i/10)"
            sleep 5
          done

          # Check frontend
          for i in {1..10}; do
            if curl -f -s http://localhost:3001/ > /dev/null; then
              echo "Frontend: OK"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "Frontend health check failed!"
              exit 1
            fi
            echo "Waiting for frontend... ($i/10)"
            sleep 5
          done

          # Check Redis
          if docker exec buhbot-redis redis-cli ping | grep -q PONG; then
            echo "Redis: OK"
          else
            echo "Redis health check failed!"
            exit 1
          fi

          echo ""
          echo "All health checks passed!"
          EOF

      - name: Rollback on failure
        if: failure() && steps.deploy.outcome == 'failure'
        run: |
          echo "Deployment failed, initiating rollback..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} << 'EOF'
          set -e
          cd ${{ env.VDS_DEPLOY_PATH }}

          echo "Running rollback..."
          if [ -x infrastructure/scripts/github-deploy.sh ]; then
            infrastructure/scripts/github-deploy.sh --rollback
          else
            # Fallback rollback
            cd infrastructure
            docker compose -f docker-compose.yml -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          fi

          echo "Rollback completed"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  # ==========================================================================
  # Notify Deployment Status
  # ==========================================================================
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [build-production, deploy-to-vds]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Telegram notification
        if: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ needs.deploy-to-vds.result }}" == "success" ]; then
            STATUS="SUCCESS"
            EMOJI="<b>[OK]</b>"
          else
            STATUS="FAILED"
            EMOJI="<b>[FAIL]</b>"
          fi

          VERSION="${{ needs.build-production.outputs.version }}"
          COMMIT="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT:0:7}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          MESSAGE="${EMOJI} BuhBot Deployment ${STATUS}

          <b>Version:</b> ${VERSION}
          <b>Commit:</b> <code>${COMMIT_SHORT}</code>
          <b>Deployed by:</b> ${ACTOR}
          <b>Time:</b> ${TIMESTAMP}

          <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Workflow</a>"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview="true" || true

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.deploy-to-vds.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.build-production.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | production |" >> $GITHUB_STEP_SUMMARY
