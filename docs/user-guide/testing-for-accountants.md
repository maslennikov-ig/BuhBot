# Инструкция для тестирования BuhBot

> **Версия:** 0.9.17
> **Дата:** 26 декабря 2025
> **Для кого:** Бухгалтеры-тестеры

---

## Как назначить бухгалтера (УПРОЩЕНО!)

Теперь достаточно **одного действия**:

1. Откройте настройки чата (Чаты → выберите чат → Настройки)
2. В поле **"Ответственный бухгалтер"** выберите бухгалтера из списка
3. Нажмите **"Сохранить"**

**Готово!** Бот автоматически будет распознавать ответы этого бухгалтера.

> **Важно:** Бухгалтер должен иметь привязанный Telegram-аккаунт (Log in with Telegram в профиле).
> Если бухгалтер ещё не привязал Telegram, его нужно попросить это сделать.

---

## Что было исправлено (26 декабря 2025)

На основе вашей обратной связи были исправлены следующие проблемы:

| # | Проблема | Статус |
|---|----------|--------|
| 1 | Бот не получал сообщения (webhook) | **ИСПРАВЛЕНО** |
| 2 | Наложение элементов: Danger Zone перекрывал выбор бухгалтера | **ИСПРАВЛЕНО** |
| 3 | Dropdown бухгалтера не отображался корректно | **ИСПРАВЛЕНО** |
| 4 | Проблема с привязкой Telegram (невалидный username) | **ПЕРЕРАБОТАНО** |
| 5 | SLA показывает нарушения без назначенного бухгалтера | **ИСПРАВЛЕНО** |
| 6 | Назначение бухгалтера не связывалось с ботом | **ИСПРАВЛЕНО** |

---

## Изменения в интерфейсе

### Привязка Telegram (НОВОЕ!)

**Было:** Ручной ввод @username (приводило к ошибкам)

**Стало:** Официальная кнопка авторизации Telegram
- Нажимаете кнопку "Log in with Telegram"
- Открывается окно Telegram
- Подтверждаете авторизацию
- Аккаунт автоматически привязывается

### Назначение бухгалтера

**Исправлено:** Выпадающий список теперь корректно отображается поверх всех элементов, включая "Опасную зону".

---

## Основные функции

### Функция 1: Назначение бухгалтеров по @username

Можно указывать ответственных бухгалтеров прямо по их Telegram @username. Это позволяет:

- Добавить нескольких бухгалтеров на один чат
- Быстро настроить, кто отвечает за клиента
- Автоматически останавливать SLA-таймер при ответе бухгалтера

### Функция 2: Привязка Telegram-аккаунта

Привяжите свой Telegram для получения уведомлений о нарушениях SLA напрямую в мессенджер.

---

## Тест 1: Добавление @username в настройках чата

### Шаги:

1. Откройте веб-панель BuhBot: **https://buhbot.aidevteam.ru**
2. Войдите в систему
3. Перейдите в раздел **«Чаты»** в левом меню
4. Выберите любой чат из списка
5. Перейдите на вкладку **«Настройки»**
6. Найдите поле **«Бухгалтеры (@username)»**

### Что проверить:

| # | Действие | Ожидаемый результат | ✓/✗ |
|---|----------|---------------------|-----|
| 1 | Введите свой @username (без @) и нажмите Enter | Username появился как «тег» с иконкой | ☐ |
| 2 | Введите @username с @ в начале | @ убралось автоматически, тег добавлен | ☐ |
| 3 | Попробуйте добавить тот же username ещё раз | Появилось сообщение «Этот username уже добавлен» | ☐ |
| 4 | Введите слишком короткий username (менее 5 букв) | Появилась ошибка валидации | ☐ |
| 5 | Нажмите **X** на любом теге | Тег удалился | ☐ |
| 6 | Добавьте 2-3 username и нажмите **«Сохранить»** | Появилось сообщение «Настройки успешно сохранены» | ☐ |
| 7 | Обновите страницу (F5) | Добавленные username остались на месте | ☐ |

---

## Тест 2: Назначение ответственного бухгалтера (БЫЛО ИСПРАВЛЕНО)

### Шаги:

1. Откройте настройки любого чата (Чаты → выберите чат → Настройки)
2. Найдите поле **«Ответственный бухгалтер»**
3. Нажмите на выпадающий список

### Что проверить:

| # | Действие | Ожидаемый результат | ✓/✗ |
|---|----------|---------------------|-----|
| 1 | Нажмите на поле выбора бухгалтера | Открылся выпадающий список с поиском | ☐ |
| 2 | Проверьте, что список виден полностью | Список НЕ перекрывается блоком "Опасная зона" | ☐ |
| 3 | Введите часть имени в поиск | Список фильтруется | ☐ |
| 4 | Выберите бухгалтера из списка | Имя появилось в поле | ☐ |
| 5 | Нажмите X справа от имени | Выбор очистился, показано "Не назначен" | ☐ |
| 6 | Выберите бухгалтера и нажмите "Сохранить" | Настройки сохранены успешно | ☐ |
| 7 | Обновите страницу | Выбранный бухгалтер остался | ☐ |

---

## Тест 3: Привязка Telegram (НОВЫЙ СПОСОБ)

### Шаги:

1. Перейдите в **Настройки** → **Профиль**
2. Найдите раздел **«Уведомления в Telegram»**

### Что проверить:

| # | Действие | Ожидаемый результат | ✓/✗ |
|---|----------|---------------------|-----|
| 1 | Проверьте наличие кнопки | Видна кнопка "Log in with Telegram" (синяя) | ☐ |
| 2 | Нажмите на кнопку | Открылось окно авторизации Telegram | ☐ |
| 3 | Авторизуйтесь в Telegram | Появилась карточка с вашим Telegram-аккаунтом | ☐ |
| 4 | Проверьте карточку | Отображается ваш username, имя и фото | ☐ |
| 5 | Нажмите "Отключить" | Появился запрос подтверждения | ☐ |
| 6 | Подтвердите отключение | Снова видна кнопка "Log in with Telegram" | ☐ |

**Важно:** Больше НЕ нужно вручную вводить @username. Авторизация происходит через официальный виджет Telegram.

---

## Тест 4: Подключение чата через бота (БЫЛО ИСПРАВЛЕНО)

### Способ А: Через ссылку (для личных чатов)

1. Перейдите в **Чаты** → **«Подключить чат»**
2. Выберите вкладку **«Ссылка»**
3. Нажмите **«Сгенерировать ссылку»**
4. Скопируйте ссылку
5. Перейдите по ней (или отправьте клиенту)
6. Нажмите "Start" в боте

| # | Проверка | Ожидаемый результат | ✓/✗ |
|---|----------|---------------------|-----|
| 1 | После нажатия Start | Бот ответил "✅ Чат успешно подключен!" | ☐ |
| 2 | В админке в разделе Чаты | Новый чат появился в списке | ☐ |
| 3 | Откройте настройки нового чата | Данные корректны (название, тип) | ☐ |

### Способ Б: Через код (для групп)

1. Сгенерируйте код в разделе **Чаты** → **«Подключить чат»** → **«Код»**
2. Добавьте бота в группу
3. Отправьте команду `/connect КОД` в группу

| # | Проверка | Ожидаемый результат | ✓/✗ |
|---|----------|---------------------|-----|
| 1 | После команды /connect | Бот ответил "✅ Чат успешно подключен!" | ☐ |
| 2 | В админке в разделе Чаты | Группа появилась в списке | ☐ |

---

## Тест 5: Проверка SLA (БЫЛО ИСПРАВЛЕНО)

### Подготовка:

1. Убедитесь, что чат подключён и SLA включён
2. Назначьте ответственного бухгалтера (или добавьте @username)

### Шаги:

1. Напишите сообщение в чат от лица клиента
2. Перейдите в **Заявки** в админке
3. Найдите новую заявку

### Что проверить:

| # | Проверка | Ожидаемый результат | ✓/✗ |
|---|----------|---------------------|-----|
| 1 | Заявка создана | Статус "Ожидает", сообщение отображается | ☐ |
| 2 | Колонка "Бухгалтер" | Показывает имя бухгалтера ИЛИ "Не назначен" | ☐ |
| 3 | Ответьте на сообщение | Статус изменился на "Отвечено" | ☐ |
| 4 | Время ответа | Отображается корректное время в минутах | ☐ |

**Примечание:** Если бухгалтер не назначен, в колонке отображается "Не назначен" (раньше было пусто или ID).

---

## Тест 6: Распознавание бухгалтера в Telegram

### Подготовка:

1. Убедитесь, что ваш @username добавлен в настройках чата
2. Откройте Telegram-чат с клиентом, где добавлен бот

### Шаги:

1. Попросите коллегу (или с другого аккаунта) написать сообщение в чат
2. Подождите несколько секунд — должна создаться заявка
3. Ответьте на сообщение от **своего** аккаунта

### Что проверить:

| # | Проверка | Ожидаемый результат | ✓/✗ |
|---|----------|---------------------|-----|
| 1 | После сообщения клиента | В веб-панели появилась заявка "Ожидает" | ☐ |
| 2 | После вашего ответа | Статус изменился на "Отвечено" | ☐ |
| 3 | Время ответа | Отображается корректное время | ☐ |

---

## Тест 7: Несколько бухгалтеров на одном чате

### Шаги:

1. В настройках чата добавьте @username двух разных бухгалтеров
2. Сохраните настройки
3. Отправьте тестовое сообщение от клиента
4. Пусть **второй** бухгалтер ответит на сообщение

### Что проверить:

| # | Проверка | Ожидаемый результат | ✓/✗ |
|---|----------|---------------------|-----|
| 1 | Ответ второго бухгалтера | Заявка закрылась (статус «Отвечено») | ☐ |
| 2 | В системе | Оба бухгалтера распознаются корректно | ☐ |

---

## Возможные проблемы и решения

### Проблема: Мой ответ не закрывает заявку

**Проверьте:**
1. Ваш @username точно добавлен в настройках чата?
2. @username написан без ошибок?
3. Вы отвечаете с того же аккаунта Telegram?

**Решение:** Откройте настройки чата и проверьте список добавленных @username

---

### Проблема: Не могу добавить @username

**Возможные причины:**
- Username слишком короткий (минимум 5 символов)
- Username содержит недопустимые символы
- Username начинается или заканчивается на `_`

**Решение:** Введите username только из букв, цифр и `_` (от 5 до 32 символов)

---

### Проблема: Не могу привязать Telegram

**Возможные причины:**
- Этот Telegram уже привязан к другому пользователю
- Проблемы с сетью

**Решение:**
1. Проверьте, не привязан ли аккаунт к другому пользователю
2. Обновите страницу и попробуйте снова
3. Попробуйте в другом браузере

---

### Проблема: Сообщение об ошибке при сохранении

**Решение:**
1. Обновите страницу
2. Попробуйте сохранить ещё раз
3. Если ошибка повторяется — сообщите разработчику

---

## Форма обратной связи

После тестирования, пожалуйста, заполните:

**Ваше имя:** _______________

**Дата тестирования:** _______________

**Результаты:**

| Тест | Пройден? | Комментарий |
|------|----------|-------------|
| Тест 1: Добавление @username | ☐ Да / ☐ Нет | |
| Тест 2: Назначение ответственного | ☐ Да / ☐ Нет | |
| Тест 3: Привязка Telegram | ☐ Да / ☐ Нет | |
| Тест 4: Подключение чата через бота | ☐ Да / ☐ Нет | |
| Тест 5: Проверка SLA | ☐ Да / ☐ Нет | |
| Тест 6: Распознавание в Telegram | ☐ Да / ☐ Нет | |
| Тест 7: Несколько бухгалтеров | ☐ Да / ☐ Нет | |

**Что работает хорошо:**

_________________________________________________

**Что не работает или работает плохо:**

_________________________________________________

**Пожелания и предложения:**

_________________________________________________

---

## Контакты для вопросов

Если что-то непонятно или возникли проблемы — пишите разработчику.

---

*Спасибо за помощь в тестировании!*
