version: '3.8'

# ============================================================================
# BuhBot Production Overrides for Docker Compose
# ============================================================================
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up
#
# VDS Constraints: 2-4 vCPU, 4-8 GB RAM (shared across all services)
# Resource Strategy: Prioritize bot-backend and redis, limit monitoring-stack
#
# Total Reserved: 2.5 vCPU, 3.75 GB RAM
# Total Limits: 5.5 vCPU, 6.25 GB RAM
# ============================================================================

services:
  # ==========================================================================
  # Bot Backend Service - HIGHEST PRIORITY
  # ==========================================================================
  # Resource allocation: 1.5 cores / 1.5 GB (limit: 2.0 cores / 2.0 GB)
  # Restart policy: always (critical service)
  # Heap size limit: 1536 MB (to prevent OOM)
  # ==========================================================================
  bot-backend:
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=3000
      - LOGGING_LEVEL=warn
      - NODE_OPTIONS=--max-old-space-size=1536
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2048M
        reservations:
          cpus: '1.5'
          memory: 1536M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ==========================================================================
  # Frontend Service - MEDIUM PRIORITY
  # ==========================================================================
  # Resource allocation: 0.5 cores / 512 MB (limit: 1.0 cores / 1.0 GB)
  # Telemetry disabled to reduce overhead
  # ==========================================================================
  frontend:
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - NEXT_TELEMETRY_DISABLED=1
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1024M
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ==========================================================================
  # Redis Service - CRITICAL, LIGHTWEIGHT
  # ==========================================================================
  # Resource allocation: 0.25 cores / 256 MB (limit: 0.5 cores / 512 MB)
  # Maxmemory reduced to 256 MB for VDS constraints
  # Read-only filesystem for security
  # ==========================================================================
  redis:
    command: redis-server --appendonly yes --appendfsync everysec --maxmemory 256mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    read_only: true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64M,mode=1777

  # ==========================================================================
  # Monitoring Stack Service - LOWEST PRIORITY
  # ==========================================================================
  # Resource allocation: 1.0 cores / 1.5 GB (limit: 1.5 cores / 2.5 GB)
  # 3 services in one container (Prometheus + Grafana + Uptime Kuma)
  # Constrained to prevent resource starvation of critical services
  # ==========================================================================
  monitoring-stack:
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2560M
        reservations:
          cpus: '1.0'
          memory: 1536M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ==========================================================================
  # Nginx Service - LIGHTWEIGHT
  # ==========================================================================
  # Resource allocation: 0.25 cores / 128 MB (limit: 0.5 cores / 256 MB)
  # Read-only filesystem for security
  # NET_BIND_SERVICE capability for binding to ports 80/443
  # ==========================================================================
  nginx:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    read_only: true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    tmpfs:
      - /var/cache/nginx:size=128M,mode=0755
      - /var/run:size=16M,mode=0755

# ============================================================================
# Resource Summary
# ============================================================================
# Service          | Reserved (CPU/RAM)    | Limit (CPU/RAM)
# ---------------- | --------------------- | ---------------------
# bot-backend      | 1.5 cores / 1.5 GB    | 2.0 cores / 2.0 GB
# frontend         | 0.5 cores / 512 MB    | 1.0 cores / 1.0 GB
# redis            | 0.25 cores / 256 MB   | 0.5 cores / 512 MB
# monitoring-stack | 1.0 cores / 1.5 GB    | 1.5 cores / 2.5 GB
# nginx            | 0.25 cores / 128 MB   | 0.5 cores / 256 MB
# ---------------- | --------------------- | ---------------------
# TOTAL            | 3.5 cores / 3.88 GB   | 5.5 cores / 6.26 GB
# ============================================================================
# VDS Capacity: 2-4 vCPU, 4-8 GB RAM
# Reserved resources fit within minimum VDS (4 vCPU, 4 GB RAM)
# Limits provide burst capacity within maximum VDS (4 vCPU, 8 GB RAM)
# ============================================================================
