name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      skip_approval:
        description: 'Skip manual approval (emergency deploy)'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  VDS_DEPLOY_PATH: /home/buhbot/BuhBot
  # Use workflow_run SHA when triggered by CI completion, otherwise current SHA (for manual or Release Please dispatch)
  DEPLOY_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
  REGISTRY: ghcr.io
  # Note: IMAGE_PREFIX is set per-job to ensure lowercase (see prepare job)

jobs:
  # ==========================================================================
  # Get Version (lightweight, no build)
  # ==========================================================================
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    # Only run if manual dispatch or Release Please triggered it
    if: github.event_name == 'workflow_dispatch'
    outputs:
      version: ${{ steps.version.outputs.version }}
      image_tag: ${{ env.DEPLOY_SHA }}
      image_prefix: ${{ steps.repo.outputs.prefix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEPLOY_SHA }}

      - name: Set lowercase repo name
        id: repo
        run: echo "prefix=ghcr.io/${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION (commit: ${{ env.DEPLOY_SHA }})"

      - name: Verify images exist in registry
        run: |
          echo "Verifying images exist in ghcr.io..."
          # Images were pushed by CI workflow, just verify they exist
          echo "Backend: ${{ steps.repo.outputs.prefix }}/backend:${{ env.DEPLOY_SHA }}"
          echo "Frontend: ${{ steps.repo.outputs.prefix }}/frontend:${{ env.DEPLOY_SHA }}"
          echo "Monitoring: ${{ steps.repo.outputs.prefix }}/monitoring:${{ env.DEPLOY_SHA }}"

  # ==========================================================================
  # Manual Approval Gate
  # ==========================================================================
  approve-deployment:
    name: Approve Deployment
    runs-on: ubuntu-latest
    needs: [prepare]
    environment: production
    if: github.event.inputs.skip_approval != true

    steps:
      - name: Deployment approved
        run: |
          echo "Deployment to production has been approved"
          echo "Commit: ${{ env.DEPLOY_SHA }}"
          echo "Version: ${{ needs.prepare.outputs.version }}"
          echo "Triggered by: ${{ github.actor }}"

  # ==========================================================================
  # Deploy to VDS (pull images from ghcr.io)
  # ==========================================================================
  deploy-to-vds:
    name: Deploy to VDS
    runs-on: ubuntu-latest
    needs: [prepare, approve-deployment]
    if: always() && needs.prepare.result == 'success' && (needs.approve-deployment.result == 'success' || github.event.inputs.skip_approval == true)
    environment:
      name: production
      url: https://buhbot.aidevteam.ru

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEPLOY_SHA }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VDS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VDS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} "echo 'SSH connection successful'"

      - name: Pull Docker images on VDS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_PREFIX: ${{ needs.prepare.outputs.image_prefix }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} << EOF
          set -e

          echo "Logging into GitHub Container Registry..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          echo "Pulling Docker images from ghcr.io..."
          docker pull ${IMAGE_PREFIX}/backend:${{ env.DEPLOY_SHA }}
          docker pull ${IMAGE_PREFIX}/frontend:${{ env.DEPLOY_SHA }}
          docker pull ${IMAGE_PREFIX}/monitoring:${{ env.DEPLOY_SHA }}

          echo "Tagging images for local use..."
          docker tag ${IMAGE_PREFIX}/backend:${{ env.DEPLOY_SHA }} buhbot-backend:${{ env.DEPLOY_SHA }}
          docker tag ${IMAGE_PREFIX}/frontend:${{ env.DEPLOY_SHA }} buhbot-frontend:${{ env.DEPLOY_SHA }}
          docker tag ${IMAGE_PREFIX}/monitoring:${{ env.DEPLOY_SHA }} buhbot-monitoring:${{ env.DEPLOY_SHA }}

          echo "Docker images pulled and tagged successfully"
          EOF

      - name: Sync repository to VDS
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} << EOF
          set -e
          cd ${{ env.VDS_DEPLOY_PATH }}
          git fetch origin main
          git reset --hard origin/main
          echo "VDS synced to $(git rev-parse --short HEAD)"
          EOF

      - name: Run deployment script on VDS
        id: deploy
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} << 'EOF'
          set -e
          cd ${{ env.VDS_DEPLOY_PATH }}

          echo "==================================="
          echo "Starting BuhBot deployment..."
          echo "Commit: ${{ env.DEPLOY_SHA }}"
          echo "Version: ${{ needs.prepare.outputs.version }}"
          echo "==================================="

          # Run the deployment script
          chmod +x infrastructure/scripts/github-deploy.sh
          infrastructure/scripts/github-deploy.sh --commit "${{ env.DEPLOY_SHA }}" --version "${{ needs.prepare.outputs.version }}"
          EOF

      - name: Health check after deployment
        id: healthcheck
        run: |
          echo "Waiting for services to start..."
          sleep 10

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} << 'EOF'
          set -e

          echo "Running health checks..."

          # Check bot-backend
          for i in {1..10}; do
            if curl -f -s http://localhost:3000/health; then
              echo ""
              echo "Bot backend: OK"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "Bot backend health check failed!"
              exit 1
            fi
            echo "Waiting for bot-backend... ($i/10)"
            sleep 3
          done

          # Check frontend
          for i in {1..10}; do
            if curl -f -s http://localhost:3001/ > /dev/null; then
              echo "Frontend: OK"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "Frontend health check failed!"
              exit 1
            fi
            echo "Waiting for frontend... ($i/10)"
            sleep 3
          done

          # Check Redis
          if docker exec buhbot-redis redis-cli ping | grep -q PONG; then
            echo "Redis: OK"
          else
            echo "Redis health check failed!"
            exit 1
          fi

          echo ""
          echo "All health checks passed!"
          EOF

      - name: Rollback on failure
        if: failure() && steps.deploy.outcome == 'failure'
        run: |
          echo "Deployment failed, initiating rollback..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} << 'EOF'
          set -e
          cd ${{ env.VDS_DEPLOY_PATH }}

          echo "Running rollback..."
          if [ -x infrastructure/scripts/github-deploy.sh ]; then
            infrastructure/scripts/github-deploy.sh --rollback
          else
            # Fallback rollback
            cd infrastructure
            docker compose -f docker-compose.yml -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          fi

          echo "Rollback completed"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  # ==========================================================================
  # Notify Deployment Status
  # ==========================================================================
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [prepare, deploy-to-vds]
    # Only notify on actual success or failure, not when skipped (CI cancelled/failed)
    if: always() && needs.deploy-to-vds.result != 'skipped'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEPLOY_RESULT: ${{ needs.deploy-to-vds.result }}
          COMMIT_SHA: ${{ env.DEPLOY_SHA }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        if: env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        run: |
          if [ "$DEPLOY_RESULT" == "success" ]; then
            MESSAGE="ðŸš€ *BuhBot Deploy*%0A%0Aâœ… SUCCESS%0A%0AðŸ“¦ Commit: \`${COMMIT_SHA:0:7}\`%0AðŸ‘¤ Author: $ACTOR%0AðŸ”— [View on GitHub]($RUN_URL)%0A%0AðŸŒ https://buhbot.aidevteam.ru"
          else
            MESSAGE="ðŸš€ *BuhBot Deploy*%0A%0AâŒ FAILED%0A%0AðŸ“¦ Commit: \`${COMMIT_SHA:0:7}\`%0AðŸ‘¤ Author: $ACTOR%0AðŸ”— [View logs]($RUN_URL)"
          fi
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true" \
            -d "text=${MESSAGE}"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.deploy-to-vds.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.prepare.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ env.DEPLOY_SHA }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | production |" >> $GITHUB_STEP_SUMMARY
